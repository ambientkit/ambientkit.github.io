"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[9610],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return m}});var i=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,i,r=function(e,t){if(null==e)return{};var n,i,r={},a=Object.keys(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=i.createContext({}),u=function(e){var t=i.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=u(e.components);return i.createElement(s.Provider,{value:t},e.children)},g={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},c=i.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),c=u(n),m=r,d=c["".concat(s,".").concat(m)]||c[m]||g[m]||a;return n?i.createElement(d,o(o({ref:t},p),{},{components:n})):i.createElement(d,o({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,o=new Array(a);o[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var u=2;u<a;u++)o[u]=n[u];return i.createElement.apply(null,o)}return i.createElement.apply(null,n)}c.displayName="MDXCreateElement"},255:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return u},toc:function(){return p},default:function(){return c}});var i=n(7462),r=n(3366),a=(n(7294),n(3905)),o=["components"],l={},s="gRPC Compiled Plugins",u={unversionedId:"plugins/grpc",id:"plugins/grpc",title:"gRPC Compiled Plugins",description:"Ambient also supports interacting with plugins over gRPC using the HashiCorp plugin system. This allows you to compile plugins and then send data back and forth just like a standard plugin. A few reasons why you may choose to go this route:",source:"@site/docs/plugins/grpc.md",sourceDirName:"plugins",slug:"/plugins/grpc",permalink:"/docs/plugins/grpc",editUrl:"https://github.com/ambientkit/ambientkit.github.io/blob/main/docs/plugins/grpc.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Enable & Disable",permalink:"/docs/plugins/enable"},next:{title:"Doc Generation",permalink:"/docs/plugins/docgen"}},p=[{value:"Plugin",id:"plugin",children:[],level:2},{value:"Ambient Usage",id:"ambient-usage",children:[],level:2},{value:"Limitations",id:"limitations",children:[],level:2},{value:"Testing",id:"testing",children:[],level:2}],g={toc:p};function c(e){var t=e.components,n=(0,r.Z)(e,o);return(0,a.kt)("wrapper",(0,i.Z)({},g,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"grpc-compiled-plugins"},"gRPC Compiled Plugins"),(0,a.kt)("p",null,"Ambient also supports interacting with plugins over gRPC using the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/hashicorp/go-plugin"},"HashiCorp plugin system"),". This allows you to compile plugins and then send data back and forth just like a standard plugin. A few reasons why you may choose to go this route:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"to dynamically load and unload plugins without restarting the application"),(0,a.kt)("li",{parentName:"ul"},"to write a plugin for Ambient in another language other than Go (it will require some non-trivial work to re-implement the plugin API)"),(0,a.kt)("li",{parentName:"ul"},"to isolate your application so plugins cannot affect your core application if they panic or leak memory"),(0,a.kt)("li",{parentName:"ul"},"to sell a plugin for Ambient, but don't want to distribute the source code")),(0,a.kt)("h2",{id:"plugin"},"Plugin"),(0,a.kt)("p",null,"To enable gRPC for your plugin, simply add a file to your plugin directory (",(0,a.kt)("inlineCode",{parentName:"p"},"cmd/plugin/main.go"),") and then update the information below with your plugin information. You must then build the binary by running: ",(0,a.kt)("inlineCode",{parentName:"p"},"go build"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'package main\n\nimport (\n    "os"\n\n    "github.com/ambientkit/ambient/pkg/grpcp"\n    "github.com/username/yourplugin"\n    "github.com/hashicorp/go-hclog"\n    "github.com/hashicorp/go-plugin"\n)\n\nfunc main() {\n    plugin.Serve(&plugin.ServeConfig{\n        HandshakeConfig: grpcp.Handshake,\n        Plugins: map[string]plugin.Plugin{\n            "yourplugin": &grpcp.GenericPlugin{Impl: yourplugin.New()},\n        },\n        Logger: hclog.New(&hclog.LoggerOptions{\n            Level:      hclog.Debug,\n            Output:     os.Stderr,\n            JSONFormat: true,\n        }),\n        GRPCServer: plugin.DefaultGRPCServer,\n    })\n}\n\n')),(0,a.kt)("h2",{id:"ambient-usage"},"Ambient Usage"),(0,a.kt)("p",null,"To reference the gRPC plugin in Ambient, add the plugin name and the path to the binary to the ",(0,a.kt)("inlineCode",{parentName:"p"},"Plugins")," array. Currently, gRPC plugins can only be used for generic and middleware plugins, they can't be used for the other core plugins."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'plugins := &ambient.PluginLoader{\n    // Core plugins are implicitly trusted.\n    Router:         awayrouter.New(h),\n    TemplateEngine: htmlengine.New(),\n    SessionManager: sessPlugin,\n    // Trusted plugins are those that are typically needed to boot so they\n    // will be enabled and given full access.\n    TrustedPlugins: trusted,\n    Plugins: []ambient.Plugin{\n        ambient.NewGRPCPlugin("yourplugin", "./yourplugin/cmd/plugin/yourplugin"),\n    },\n    Middleware: []ambient.MiddlewarePlugin{\n        // Middleware - executes top to bottom.\n        sessPlugin,\n        ambient.NewGRPCPlugin("yourmwplugin", "./yourmwplugin/cmd/plugin/yourmwplugin"),\n    },\n}\n')),(0,a.kt)("h2",{id:"limitations"},"Limitations"),(0,a.kt)("p",null,"There are a few limitations when using gRPC plugins because of the nature of the communication. You will need to keep these use cases in mind:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"storing values in request context"),": if you are relying on ",(0,a.kt)("inlineCode",{parentName:"li"},"context")," from ",(0,a.kt)("inlineCode",{parentName:"li"},"http.Request")," in your middleware and routes to store and read values, it will be restricted to just your plugin. There is no way to serialize context values because you can't iterate over them so they won't pass between the server and plugin. The context is stored in a map from either the middleware or routes and then it's accessible by routes and funcmaps, respectively."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"using non-primitives when passing data into templates"),": if you try to pass in a template.HTML via vars, it will be converted to string after serialization/deserialization via gRPC since gRPC only supports primitives. The suggested approach is to use a FuncMap instead that returns escaped HTML (",(0,a.kt)("inlineCode",{parentName:"li"},"template.HTML"),"). ",(0,a.kt)("a",{parentName:"li",href:"https://github.com/golang/protobuf/issues/1302"},"Reference"),"."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"passing data into templates will be run through marshal/unmarshal in JSON"),": if you don't use JSON tags and then use capital letters, gRPC will respect the capitalization. If you do use JSON tags, then gRPC will use the JSON tag as the name during serialization/deserialization. We force this even when using standard plugins so there is consistency between standard plugins and gRPC plugins. You can read more about here in the ",(0,a.kt)("a",{parentName:"li",href:"/docs/architecture/template-engine"},"Template Engine")," section.")),(0,a.kt)("p",null,"If you want to take a closer look at the definitions, all of the data that is transferred between the server and the plugins is documented in these ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/ambientkit/ambient/tree/main/pkg/grpcp/protobuf"},(0,a.kt)("inlineCode",{parentName:"a"},".proto")," files"),"."),(0,a.kt)("h2",{id:"testing"},"Testing"),(0,a.kt)("p",null,"There is a test suite that is shared between standard and gRPC plugins available in the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/ambientkit/plugin/blob/main/pkg/grpctestutil/grpcp_test.go"},"plugin repository"),". It's separate from the ",(0,a.kt)("inlineCode",{parentName:"p"},"ambient")," repository because it requires real plugins to do the testing so to limit dependencies back and forth, we separated them for now. If you find there are inconsistencies between when a plugin is accessed using the standard method vs the gRPC method, please ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/ambientkit/ambient/issues"},"let us know"),"."))}c.isMDXComponent=!0}}]);